<project name="WilmaScope" default="all" basedir=".">

  <!-- set global properties for this build -->
  <property name="src" value="src"/>
  <property name="doc" value="doc"/>
  <property name="lib" value="lib"/>
  <property name="dest" value="classes"/>
  <property name="dist"  value="dist"/>
  <property name="wilmahost"  value="localhost"/>
  <property name="wilmaport"  value="58317"/>
  <property name="optimization"  value="on"/>
  <property name="cvsroot"  
    value="tgdwyer@cvs.wilma.sourceforge.net:/cvsroot/wilma"/>
  <target name="init">
    <!-- Create the time stamp -->
    <tstamp/>
    <!-- Create the build directory structure used by compile -->
    <mkdir dir="${dest}"/>
    <mkdir dir="${doc}"/>
    <mkdir dir="${src}/org/wilmascope/chat"/>
  </target>

  <target name="idlcheck"
     description="check if source generated from idl is up to date">
    <uptodate property="idl.required" targetfile="${src}/idl/WilmaChat.idl">
      <srcfiles dir="${src}/org/wilmascope/chat"/>
    </uptodate>
  </target>

  <target name="idl" depends="idlcheck" if="idl.required" 
     description="Generating CORBA stubs/skeletons...">
    <exec dir="${src}" executable="idlj">
      <arg value="-fall"/>
      <arg value="-verbose"/>
      <arg file="${src}/idl/WilmaChat.idl"/>
    </exec>
    <exec dir="${src}" executable="idlj">
      <arg value="-fallTIE"/>
      <arg value="-verbose"/>
      <arg file="${src}/idl/WilmaChat.idl"/>
    </exec>
  </target>

  <target name="chat" depends="idl,compile"
    description="compile all the CORBA stuff including the generated code, the Wilma Server and the sample client">
    <!-- Compile the java code from ${src} into ${classes} -->
    <javac srcdir="${src}" destdir="${dest}" optimize="${optimization}"
       includes="org/wilmascope/chat/**,org/wilmascope/control/TalkingGraph.java,org/wilmascope/TestChatClient.java" >
    </javac>
  </target>

  <target name="compile" depends="init"
    description="Compile just the core wilma code">
    <!-- Compile the java code from ${src} into ${classes} -->
    <javac srcdir="${src}" destdir="${dest}" optimize="${optimization}"
       excludes="org/wilmascope/chat/**,org/wilmascope/TestChatClient.java,org/wilmascope/control/TalkingGraph.java,org/wilmascope/control/WilmaChatServCORBA.java">
    </javac>
  </target>

  <target name="dist" depends="compile">
    <!-- Create the distribution directory -->
    <!-- Put everything in ${build} into the MyProject-${DSTAMP}.jar file -->
    <mkdir dir="${dest}/images"/>
    <copy todir="${dest}/images" >
      <fileset dir="${lib}/images"/>
    </copy>
    <jar manifest="META-INF/MANIFEST.MF" jarfile="${lib}/wilma.jar" basedir="${dest}"/>
    <!--
    -->
  </target>
  <target name="distpackage" depends="dist">
    <mkdir dir="${dist}/bin"/>
    <copy file="README" todir="${dist}"/>
    <copy file="COPYING" todir="${dist}"/>
    <copy todir="${dist}/${lib}">
      <fileset dir="${lib}"/>
    </copy>
    <copy todir="${dist}/userdoc">
      <fileset dir="userdoc" excludes="book/**"/>
    </copy>
    <copy todir="${dist}/data">
      <fileset dir="data"/>
    </copy>
    <copy todir="${dist}/bin" >
      <fileset dir="bin"/>
    </copy>
    <mkdir dir="Wilma"/>
    <copy todir="Wilma"><fileset dir="dist"/></copy>
    <zip zipfile="Wilma_${DSTAMP}.zip">
      <zipfileset dir="Wilma" prefix="Wilma"/>
    </zip>
    <tar tarfile="Wilma_${DSTAMP}.tar">
      <tarfileset dir="." includes="Wilma/bin/**" mode="755"/>
      <tarfileset dir="." includes="Wilma/**" excludes="Wilma/bin/**"/>
    </tar>
    <gzip src="Wilma_${DSTAMP}.tar" zipfile="Wilma_${DSTAMP}.tar.gz" />
    <delete file="Wilma_${DSTAMP}.tar"/>
    <delete dir="Wilma"/>
  </target>

  <target name="all" depends="clean, compile, dist, doc, distpackage">
  </target>

  <target name="build" depends="compile">
  </target>

  <target name="run" depends="compile" 
    description="run interactive Wilma session">
    <java classname="org.wilmascope.control.WilmaMain" dir="${lib}" fork="yes">
      <classpath>
        <pathelement location="${dest}"/>
      </classpath>
    </java>
  </target>
  <target name="rundist" depends="dist" 
    description="run interactive Wilma session from jar">
    <java classname="org.wilmascope.control.WilmaMain" fork="yes">
      <classpath>
        <pathelement location="wilma.jar"/>
      </classpath>
    </java>
  </target>

  <target name="doc" description="generate javadoc documentation">
    <mkdir dir="${doc}"/>
    <javadoc sourcepath="${src}" packagenames="org.wilmascope.graph,org.wilmascope.control,org.wilmascope.view,org.wilmascope.patterns,org.wilmascope.gui,org.wilmascope.global,org.wilmascope.forcelayout,org.wilmascope.file,org.wilmascope.dotlayout,org.wilmascope" destdir="${doc}"/>
  </target>
  <target name="none"></target>
  <target name="clean">
    <!-- Delete the ${build} and ${dist} directory trees -->
    <delete dir="${dest}"/>
    <delete dir="${dist}"/>
    <delete dir="${src}/org/wilmascope/chat"/>
    <delete dir="${doc}"/>
    <delete file="${lib}/wilma.jar"/>
  </target>
  <target name="update" depends="clean"
    description="check source out of cvs">
    <cvs command="update" 
      cvsroot="${cvsroot}"/>
  </target>
</project>

